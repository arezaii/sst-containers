name: Build Custom SST Containers from Git

on:
  workflow_dispatch:
    inputs:
      sst_core_repo:
        description: 'SST-core repository URL'
        required: false
        default: 'https://github.com/sstsimulator/sst-core.git'
        type: string
      sst_core_ref:
        description: 'SST-core branch, tag, or commit SHA'
        required: true
        type: string
      sst_elements_repo:
        description: 'SST-elements repository URL (leave empty for core-only build)'
        required: false
        type: string
      sst_elements_ref:
        description: 'SST-elements branch, tag, or commit SHA (required if elements_repo provided)'
        required: false
        type: string
      mpich_version:
        description: 'MPICH version to use'
        required: false
        default: '4.0.2'
        type: string
      build_platforms:
        description: 'Platforms to build for'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64'
          - 'linux/arm64'
      custom_tag_suffix:
        description: 'Optional tag suffix (default: short SHA of core ref)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      build_type: ${{ steps.validate.outputs.build_type }}
      tag_suffix: ${{ steps.validate.outputs.tag_suffix }}
    steps:
      - name: Validate inputs and determine build parameters
        id: validate
        run: |
          # Determine build type
          if [ -n "${{ inputs.sst_elements_repo }}" ]; then
            if [ -z "${{ inputs.sst_elements_ref }}" ]; then
              echo "::error::SST-elements ref is required when elements_repo is provided"
              exit 1
            fi
            echo "build_type=full" >> $GITHUB_OUTPUT
          else
            echo "build_type=core" >> $GITHUB_OUTPUT
          fi

          # Determine tag suffix
          if [ -n "${{ inputs.custom_tag_suffix }}" ]; then
            echo "tag_suffix=${{ inputs.custom_tag_suffix }}" >> $GITHUB_OUTPUT
          else
            # Get short SHA for tagging
            CORE_SHA="${{ inputs.sst_core_ref }}"
            CORE_SHORT_SHA=$(echo "$CORE_SHA" | cut -c1-7)

            # Extract repo owner from core repo URL
            REPO_URL="${{ inputs.sst_core_repo }}"
            REPO_OWNER=$(echo "$REPO_URL" | sed -E 's/.*[:/]([^/]+)\/[^/]+\.git/\1/')
            echo "tag_suffix=${REPO_OWNER}-${CORE_SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

          echo "::notice::Build type: $(cat $GITHUB_OUTPUT | grep build_type | cut -d= -f2)"
          echo "::notice::Tag suffix: $(cat $GITHUB_OUTPUT | grep tag_suffix | cut -d= -f2)"

  build-custom-containers:
    needs: [validate-inputs]
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-sst-containers-reusable.yml
    with:
      container_type: '${{ needs.validate-inputs.outputs.build_type }}'
      image_prefix: '${{ github.repository_owner }}/ar-sst'
      tag_suffix: '${{ needs.validate-inputs.outputs.tag_suffix }}'
      build_platforms: '${{ inputs.build_platforms }}'
      mpich_version: '${{ inputs.mpich_version }}'
      sst_core_repo: '${{ inputs.sst_core_repo }}'
      sst_core_ref: '${{ inputs.sst_core_ref }}'
      sst_elements_repo: '${{ inputs.sst_elements_repo }}'
      sst_elements_ref: '${{ inputs.sst_elements_ref }}'
      containerfile_path: 'Containerfiles/Containerfile.tag'
      docker_context: 'Containerfiles'
      build_target: ${{ needs.validate-inputs.outputs.build_type == 'full' && 'sst-full' || 'sst-core' }}
    secrets: inherit

  validate-custom-containers:
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/validate-sst-containers-reusable.yml
    needs: [build-custom-containers]
    if: needs.build-custom-containers.result == 'success'
    with:
      container_type: '${{ needs.validate-inputs.outputs.build_type }}'
      image_tags: '${{ needs.build-custom-containers.outputs.built_images }}'
      build_platforms: '${{ inputs.build_platforms }}'
      max_image_size_mb: 2048
    secrets: inherit

  generate-summary:
    uses: ./.github/workflows/generate-build-summary-reusable.yml
    needs: [validate-inputs, build-custom-containers, validate-custom-containers]
    if: always()
    with:
      workflow_type: 'custom'
      container_type: '${{ needs.validate-inputs.outputs.build_type }}'
      build_successful: ${{ needs.build-custom-containers.result == 'success' }}
      manifest_successful: ${{ needs.build-custom-containers.result == 'success' }}
      validation_successful: ${{ needs.validate-custom-containers.result == 'success' }}
      manifest_tag: '${{ needs.build-custom-containers.outputs.manifest_tag }}'
      built_images: '${{ needs.build-custom-containers.outputs.built_images }}'
      build_platforms: '${{ inputs.build_platforms }}'
      tag_suffix: '${{ needs.validate-inputs.outputs.tag_suffix }}'
      mpich_version: '${{ inputs.mpich_version }}'
